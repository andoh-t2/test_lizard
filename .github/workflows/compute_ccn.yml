name: Lizard on PR Comment (Diff Only)

on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  lizard-on-label:
    if: contains(github.event.pull_request.labels.*.name, 'compute-ccn')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python and Install Lizard
        run: pip install lizard
      
      - name: Filter for C++ files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å–å¾—
          list-files: shell
          # 'cpp'ã¨ã„ã†åå‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚’å®šç¾©
          filters: |
            cpp:
              - '**/*.cpp'
              - '**/*.hpp'

      - name: Run Lizard on changed files
        if: steps.changes.outputs.cpp == 'true'
        id: lizard
        run: |
          pip install lizard

          echo "Running Lizard on: ${{ steps.changes.outputs.cpp_files }}"
          
          if lizard_output=$(lizard --CCN 7 --length 150 --arguments 7 -T nloc=100 ${{ steps.changes.outputs.cpp_files }}); then
            exit_code=0
          else
            exit_code=$?
          fi

          # çµ‚äº†ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†å²
          if [ $exit_code -eq 0 ]; then
            {
              echo 'âœ… **Cyclomatic Complexity Report (No warnings)**'
              echo ""
              echo "No functions exceeded the complexity threshold."
            } > comment-body.txt
          else
            {
              echo 'âš ï¸ğŸ§¨ **Cyclomatic Complexity Report (Warnings found)** ğŸ‘®ğŸš¨'
              echo ""
              echo "One or more functions exceeded the complexity threshold."
            } > comment-body.txt
          fi

      # C++ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒãªã‹ã£ãŸå ´åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
      - name: Prepare "No Changes" comment
        if: steps.changes.outputs.cpp == 'false'
        id: no_changes
        run: |
          echo "ğŸ˜´ **Cyclomatic Complexity Report**" > comment-body.txt
          echo "" >> comment-body.txt
          echo "No changed C++ files to analyze." >> comment-body.txt
          echo "comment_file=comment-body.txt" >> $GITHUB_OUTPUT

      - name: Post comment to PR
        # lizardã‹no_changesã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: success() && (steps.lizard.outputs.comment_file || steps.no_changes.outputs.comment_file)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_FILE="${{ steps.lizard.outputs.comment_file || steps.no_changes.outputs.comment_file }}"
          gh pr comment ${{ github.event.number }} --body-file "$COMMENT_FILE"
